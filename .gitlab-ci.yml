stages:
  - build
  - test
  - package
  - deploy

variables:
  CGO_ENABLED: "0"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  REGISTRY: registry.gitlab.com/uptimeping
  VERSION: ${CI_COMMIT_TAG:-latest}

# Общие настройки для задач на Go
.go-template: &go-template
  image: golang:1.24-alpine
  cache:
    key: go-cache-${CI_COMMIT_REF_SLUG}
    paths:
      - /go/pkg/mod
      - /go/.cache
  before_script:
    - apk add --no-cache git make
    - go version
    - echo "${CI_COMMIT_SHA}" > VERSION
    - echo "${CI_COMMIT_TIMESTAMP}" > BUILD_TIME

# Настройка Docker
.docker-template: &docker-template
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# Сборка всех микросервисов
build-services:
  <<: *go-template
  stage: build
  script:
    - echo "Сборка всех микросервисов..."
    - make build-all
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

# Сборка Docker образов
docker-build:
  <<: *docker-template
  stage: build
  script:
    - echo "Сборка Docker образов..."
    - make docker-build
    - echo "Тегирование образов..."
    - make docker-tag
  dependencies:
    - build-services

# Запуск тестов для всех сервисов
test-services:
  <<: *go-template
  stage: test
  script:
    - echo "Запуск тестов для всех сервисов..."
    - make test
  coverage: '/coverage: \d+\.\d+% of statements/'
  artifacts:
    reports:
      junit: services/*/coverage.xml
    paths:
      - services/*/coverage.html
    expire_in: 1 hour

# Тестирование с покрытием
test-coverage:
  <<: *go-template
  stage: test
  script:
    - echo "Запуск тестов с покрытием..."
    - make test-coverage
  coverage: '/coverage: \d+\.\d+% of statements/'
  artifacts:
    reports:
      junit: services/*/coverage.xml
      coverage_report:
        coverage_format: cobertura
        path: services/*/coverage.xml
    paths:
      - services/*/coverage.html
      - services/*/coverage.out
    expire_in: 1 hour

# Создание DEB пакетов
package-deb:
  <<: *go-template
  stage: package
  script:
    - echo "Создание DEB пакетов..."
    - apt-get update && apt-get install -y dpkg-dev
    - make package-deb
  artifacts:
    paths:
      - dist/deb/*.deb
    expire_in: 1 week
  only:
    - tags
    - master

# Создание RPM пакетов
package-rpm:
  <<: *go-template
  stage: package
  script:
    - echo "Создание RPM пакетов..."
    - apt-get update && apt-get install -y rpm
    - make package-rpm
  artifacts:
    paths:
      - dist/rpm/*.rpm
    expire_in: 1 week
  only:
    - tags
    - master

# Создание Homebrew formula
package-homebrew:
  <<: *go-template
  stage: package
  script:
    - echo "Создание Homebrew formula..."
    - make package-homebrew
  artifacts:
    paths:
      - dist/homebrew/uptimeping.rb
    expire_in: 1 week
  only:
    - tags
    - master

# Создание Chocolatey пакета
package-chocolatey:
  <<: *go-template
  stage: package
  script:
    - echo "Создание Chocolatey пакета..."
    - make package-chocolatey
  artifacts:
    paths:
      - dist/chocolatey/uptimeping.nuspec
    expire_in: 1 week
  only:
    - tags
    - master

# Отправка Docker образов
docker-push:
  <<: *docker-template
  stage: deploy
  script:
    - echo "Отправка Docker образов..."
    - make docker-push
  dependencies:
    - docker-build
    - test-services
  only:
    - tags
    - master

# Развертывание в production
deploy-production:
  <<: *docker-template
  stage: deploy
  script:
    - echo "Развертывание в production..."
    - echo "${CI_COMMIT_SHA}" > VERSION
    - echo "${CI_COMMIT_TIMESTAMP}" > BUILD_TIME
    - docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull
    - docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
  environment:
    name: production
    url: https://uptimeping.local
  dependencies:
    - docker-push
    - test-coverage
  only:
    - tags
  when: manual

# Развертывание в staging
deploy-staging:
  <<: *docker-template
  stage: deploy
  script:
    - echo "Развертывание в staging..."
    - echo "${CI_COMMIT_SHA}" > VERSION
    - echo "${CI_COMMIT_TIMESTAMP}" > BUILD_TIME
    - docker-compose -f docker-compose.yml -f docker-compose.dev.yml pull
    - docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
  environment:
    name: staging
    url: https://staging.uptimeping.local
  dependencies:
    - docker-build
    - test-services
  only:
    - develop
    - master
  when: manual

# Очистка старых образов
cleanup:
  <<: *docker-template
  stage: deploy
  script:
    - echo "Очистка старых Docker образов..."
    - docker system prune -f
    - docker volume prune -f
  when: manual

# Безопасность
security-scan:
  <<: *go-template
  stage: test
  script:
    - echo "Сканирование безопасности..."
    - go install github.com/securecodewarrior/govulncheck/cmd/govulncheck@latest
    - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
    - govulncheck ./...
    - golangci-lint run ./...
  allow_failure: true

# Сборка метрик
metrics:
  <<: *go-template
  stage: test
  script:
    - echo "Сборка метрик..."
    - go install github.com/alecthomas/gocognize@latest
    - go install github.com/fzipp/gocyclo@latest
    - gocognize ./...
    - gocyclo -over ./...
  allow_failure: true
  artifacts:
    reports:
      metrics: metrics.txt